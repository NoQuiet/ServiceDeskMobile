# Service Desk Mobile

Мобильное приложение для системы техподдержки с поддержкой трех ролей пользователей: администратор, специалист техподдержки и обычный пользователь.

## Возможности

### Для обычных пользователей:
- ✅ Регистрация с заполнением профиля (ФИО, email, телефоны, этаж, кабинет, должность)
- ✅ Создание заявок в техподдержку
- ✅ **Прикрепление фотографий к заявкам** (до 5 фото, макс. 5 МБ каждое)
- ✅ Просмотр статуса своих заявок
- ✅ Переписка с техподдержкой через комментарии
- ✅ **Прикрепление фотографий к комментариям** (до 5 фото)
- ✅ Удаление своих комментариев
- ✅ Оценка выполненной работы (1-5 звезд)
- ✅ Редактирование своего профиля

### Для специалистов техподдержки:
- ✅ Просмотр всех активных заявок
- ✅ Просмотр деталей любой заявки
- ✅ Взятие заявки в работу
- ✅ Изменение статуса заявки
- ✅ Переписка с пользователями через комментарии
- ✅ Возможность взять заявку даже если она назначена на другого специалиста

### Для администраторов:
- ✅ Все возможности специалиста техподдержки
- ✅ Просмотр архива выполненных заявок
- ✅ Просмотр всех переписок
- ✅ Создание новых специалистов техподдержки
- ✅ Редактирование учетных записей пользователей
- ✅ Блокировка/разблокировка пользователей
- ✅ Удаление учетных записей
- ✅ Назначение заявок на конкретных специалистов

## Технологии

### Backend:
- Node.js + Express
- MySQL
- JWT аутентификация
- bcrypt для хеширования паролей
- **Multer для загрузки файлов**

### Android App:
- Kotlin
- Jetpack Compose
- Material Design 3
- Retrofit для API запросов
- **Coil для загрузки и отображения изображений**
- DataStore для хранения токенов
- Navigation Compose
- Coroutines & Flow

## Установка и запуск

### 1. Настройка базы данных MySQL

```bash
# Создайте базу данных
mysql -u root -p < backend/database/schema.sql
```

### 2. Настройка и запуск backend сервера

```bash
cd backend

# Установите зависимости
npm install

# Создайте файл .env
cp .env.example .env

# Отредактируйте .env и укажите параметры подключения к БД
# DB_HOST=localhost
# DB_USER=root
# DB_PASSWORD=your_password
# DB_NAME=service_desk
# JWT_SECRET=your_secret_key

# Запустите сервер
npm start

# Для разработки с автоперезагрузкой:
npm run dev
```

Сервер будет доступен по адресу: `http://localhost:3000`

### 3. Настройка Android приложения

1. Откройте проект в Android Studio
2. Убедитесь, что backend сервер запущен
3. Если вы используете эмулятор Android, сервер будет доступен по адресу `10.0.2.2:3000`
4. Если вы используете физическое устройство, измените BASE_URL в файле `RetrofitClient.kt` на IP адрес вашего компьютера
5. Синхронизируйте Gradle и запустите приложение

## Структура проекта

```
ServiceDeskMobile/
├── backend/                          # Backend сервер
│   ├── config/                       # Конфигурация БД
│   ├── database/                     # SQL схема
│   ├── middleware/                   # Middleware (аутентификация)
│   ├── routes/                       # API маршруты
│   │   ├── auth.js                  # Аутентификация
│   │   ├── tickets.js               # Заявки
│   │   ├── comments.js              # Комментарии
│   │   └── users.js                 # Пользователи
│   ├── server.js                    # Главный файл сервера
│   └── package.json
│
└── app/                              # Android приложение
    └── src/main/java/com/example/servicedeskmobile/
        ├── data/                     # Слой данных
        │   ├── api/                 # API клиент
        │   ├── model/               # Модели данных
        │   └── repository/          # Репозитории
        ├── ui/                      # UI слой
        │   ├── screen/              # Экраны приложения
        │   ├── viewmodel/           # ViewModels
        │   └── theme/               # Тема приложения
        ├── navigation/              # Навигация
        └── MainActivity.kt
```

## Приоритеты заявок

1. **Низкий** (low) - зеленый цвет
2. **Средний** (medium) - желтый цвет
3. **Высокий** (high) - оранжевый цвет
4. **Критический** (critical) - красный цвет

## Статусы заявок

1. **new** - Новая заявка (синий цвет)
2. **in_progress** - В работе (оранжевый цвет)
3. **resolved** - Решена (зеленый цвет)
4. **closed** - Закрыта (серый цвет)

**Примечание:** Статус "archived" удален из UI, но остается в БД для совместимости.

## API Endpoints

### Аутентификация
- `POST /api/auth/register` - Регистрация
- `POST /api/auth/login` - Вход
- `POST /api/auth/logout` - Выход
- `GET /api/auth/me` - Текущий пользователь

### Заявки
- `GET /api/tickets` - Список заявок
- `GET /api/tickets/:id` - Детали заявки
- `POST /api/tickets` - Создать заявку
- `POST /api/tickets/:id/attachments` - **Загрузить фото к заявке**
- `GET /api/tickets/:id/attachments` - **Получить фото заявки**
- `PUT /api/tickets/:id/status` - Изменить статус
- `PUT /api/tickets/:id/assign` - Назначить специалиста
- `POST /api/tickets/:id/take` - Взять в работу
- `PUT /api/tickets/:id/rate` - Оценить заявку
- `GET /api/tickets/archived` - Архив (только admin)

### Комментарии
- `GET /api/tickets/:ticketId/comments` - Комментарии к заявке
- `POST /api/comments` - Добавить комментарий
- `POST /api/comments/:id/attachments` - **Загрузить фото к комментарию**
- `GET /api/comments/:id/attachments` - **Получить фото комментария**
- `DELETE /api/comments/:id` - Удалить комментарий

### Пользователи
- `GET /api/users` - Список пользователей (admin/support)
- `GET /api/users/:id` - Данные пользователя
- `PUT /api/users/:id` - Обновить профиль
- `POST /api/users/support` - Создать специалиста (admin)
- `PATCH /api/users/:id/block` - Блокировать пользователя (admin)
- `DELETE /api/users/:id` - Удалить пользователя (admin)

## Работа с изображениями

### Загрузка фотографий
- **К заявкам:** До 5 фотографий при создании заявки
- **К комментариям:** До 5 фотографий при добавлении комментария
- **Максимальный размер:** 5 МБ на файл
- **Форматы:** JPEG, JPG, PNG

### Хранение файлов
Загруженные изображения сохраняются в директории `backend/uploads/`:
- `uploads/tickets/{ticketId}/` - фотографии заявок
- `uploads/comments/{commentId}/` - фотографии комментариев

### Отображение
- В заявках: горизонтальная галерея с превью 120x120px
- В комментариях: горизонтальная галерея с превью 100x100px
- Скругленные углы и адаптивное масштабирование

## Учетные данные по умолчанию

После создания базы данных доступна учетная запись администратора:
- **Email:** admin@servicedesk.local
- **Пароль:** admin123

⚠️ **Важно:** Измените пароль администратора после первого входа!

## Безопасность

- Пароли хешируются с использованием bcrypt
- JWT токены для аутентификации
- Валидация всех входных данных
- Защита от SQL инъекций
- Проверка прав доступа на уровне API

## Разработка

### Требования
- Node.js 14+
- MySQL 5.7+
- Android Studio Arctic Fox или новее
- JDK 11+
- Android SDK (API 24+)

### Полезные команды

Backend:
```bash
npm start          # Запуск сервера
npm run dev        # Запуск с автоперезагрузкой
```

Android:
```bash
./gradlew build    # Сборка проекта
./gradlew clean    # Очистка проекта
```

## Лицензия

MIT License

## Поддержка

При возникновении проблем создайте issue в репозитории проекта.
